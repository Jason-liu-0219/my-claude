<template>
  <AppDialogue
    ref="modal"
    class="device-access-dialogue"
    data-testid="device-access-dialogue"
    name="DeviceAccessDialogue"
    :closeWhenClickButton="closeOnSelect"
    :title="dialogueTitle"
    :subTitle="subTitle"
    :primaryText="isProcessing ? $t('Selecting') : $t('Select')"
    :buttonIconStatusMapping="buttonIconStatusMapping"
    :state="modalState"
    height="720px"
    width="1116px"
    @confirm="handleConfirm"
  >
    <template #content>
      <div class="content-wrapper">
        <div class="hint">
          <h3 class="bold">
            {{ selectedLengthHint }}
          </h3>
        </div>
        <div class="dialogue-content">
          <div class="left-menu">
            <DeviceGroupList
              :multiple="multiple"
              :groupList="sites"
              :currentSelectedGroups="currentSelectedSites"
              :currentSelectedDevices="currentSelectedDevices"
              :focusGroupId="focusSiteId"
              :isSearching="isSearching"
              :additionalGroupTypes="additionalGroupTypes"
              @toggleSelectedGroups="toggleSelectedSites"
              @changeFocusGroup="changeFocusSiteAndClearInput"
            >
              <template #group-icon="{ group }">
                <SvgIcon
                  :iconClass="customGroupIcon[group.type]"
                  size="24px"
                />
              </template>
            </DeviceGroupList>
          </div>
          <div class="center-view">
            <div class="search-container">
              <AppInputFields
                id="search-device-fields"
                v-model.lazy="searchName"
                class="search-input"
                type="search"
                :disabled="devices.length === 0"
                @change="searchInputChange"
              />
            </div>
            <template v-if="hasSearchResult">
              <div
                v-if="currentFocusSiteInfo"
                class="site-header-container"
              >
                <h6 class="site-hint">
                  {{ currentFocusSiteInfo }}
                </h6>
              </div>
              <div class="site-batch-assign-container">
                <h6 class="site-batch-selector-hint">
                  {{ t('Update Selected Devices Access') }}
                </h6>
                <div class="site-batch-assign-selector">
                  <DeviceRoleDropdown
                    class="device-role-dropdown"
                    :modelValue="currentBatchAssignRoleId"
                    :placeholder="t('Select Role to assign')"
                    :disabled="isBatchAssignDisabled"
                    @selected="batchAssignRole"
                  />
                </div>
              </div>
              <div
                ref="siteList"
                class="site-list"
              >
                <div
                  v-for="(_site, index) in filteredSites"
                  :key="index"
                  class="site-wrapper"
                >
                  <template v-if="displayDevices[_site.id]">
                    <h6
                      class="site-title"
                      :title="_site.name"
                    >
                      {{ _site.name }}
                    </h6>
                    <div class="site-device-container">
                      <template v-if="multiple">
                        <AppCheckBox
                          v-model.lazy="isSelectAllMap[_site.id]"
                          :indeterminate="checkIsSelectIndeterminate(_site.devices)"
                          :disabled="_site.devices.length === 0"
                          @click.prevent="selectAll(_site.id)"
                        />
                      </template>
                      <div class="site-device-subtitle-container">
                        <div class="device-subtitle">
                          {{ t('Devices') }}
                        </div>
                        <div class="device-role-dropdown-subtitle">
                          {{ t('Device Access Role') }}
                        </div>
                      </div>
                    </div>
                  </template>
                  <AppDeviceList
                    class="site-device-list"
                    :multiple="multiple"
                    :selectMode="!multiple"
                    :devicesData="displayDevices[_site.id]"
                    :activeDeviceId="activeDeviceId"
                    :defaultSelectedDevices="currentSelectedDevices"
                    :enableListItemActive="false"
                    :shouldDisplayThumbnail="shouldDisplayThumbnail(_site.type)"
                    @toggleSelectedDevices="toggleSelectedDevices"
                    @selectDevice="selectDevice"
                  >
                    <template #rear="{ device }">
                      <DeviceIndicator
                        v-if="device.nvrName"
                        :device="device"
                      />
                      <DeviceIndicator
                        v-if="device.vssName"
                        :device="device"
                      />
                    </template>
                    <template #dropdown="{ device }">
                      <DeviceRoleDropdown
                        class="device-role-dropdown"
                        :modelValue="deviceRoles[device.deviceId]?.roleId || ''"
                        :placeholder="$t('Select Role')"
                        :initialDisplayText="deviceRoles[device.deviceId]?.roleName || ''"
                        @selected="(role) => updateDeviceRole(device.deviceId, role)"
                      />
                    </template>
                  </AppDeviceList>
                </div>
              </div>
            </template>
            <div
              v-else
              class="no-result-container"
            >
              <SvgIcon
                class="no-result-icon"
                :iconClass="`search_failed`"
                size="100px"
              />
              <h6 class="text">
                {{ $t('No search results') }}
              </h6>
            </div>
          </div>
        </div>
      </div>
    </template>
    <template
      v-if="isError"
      #errorMessage
    >
      <AppFormErrorMessage :message="errorMessage" />
    </template>
  </AppDialogue>
</template>

<script setup>
import { ref, computed, useTemplateRef, onMounted } from 'vue';
import { useI18n } from 'vue-i18n';
import { useStore } from 'vuex';

import { DeviceIndicator, DeviceGroupList, AppDeviceList } from '@vivotek/advanced-vue-components';
import { DIALOGUE, GROUP_TYPES, GROUP_ICONS } from '@vivotek/const-vsaas';

import DeviceRoleDropdown from '@/components/Dropdowns/DeviceRoleDropdown.vue';
import { PERMISSION_DEVICE_SCOPE } from '@/constants/Permission';
import { useDeviceRoleHelper } from '@/pages/user/detail/composables/useDeviceRoleHelper';

const props = defineProps({
  multiple: {
    type: Boolean,
    default: true,
  },
  availableDevices: {
    type: Array,
    default: () => [],
  },
  closeOnSelect: {
    type: Boolean,
    default: false,
  },
  title: {
    type: String,
    default: '',
  },
  subTitle: {
    type: String,
    default: '',
  },
  userId: {
    type: String,
    default: '',
  },
});

const emit = defineEmits(['success']);

const store = useStore();
const { t } = useI18n();

const modal = useTemplateRef('modal');
const siteList = useTemplateRef('siteList');

const modalState = ref(DIALOGUE.STATE.DEFAULT);
const searchName = ref('');
const focusSiteId = ref('');
const batchAssignRoleId = ref({});

const groupState = computed(() => store.state.group);
const getAvailableDevicesWithPermission = computed(() =>
  store.getters['device/getAvailableDevicesWithPermission'](PERMISSION_DEVICE_SCOPE.DEVICE_ALL_USERS),
);
const errorMessage = computed(() => {
  if (isError.value) {
    return t('Failed to assign device roles');
  }
  return '';
});
const customGroupIcon = computed(() => {
  return {
    ...GROUP_ICONS,
    [GROUP_TYPES.SITE]: 'general_site_solid',
    [GROUP_TYPES.NETWORK_SPEAKER]: 'general_speaker_solid',
    [GROUP_TYPES.POE_SWITCH]: 'general_poe_solid',
  };
});

const devices = computed(() => {
  if (props.availableDevices.length > 0) {
    return props.availableDevices;
  }
  return getAvailableDevicesWithPermission.value || [];
});

const {
  sites,
  deviceRoles,
  currentSelectedDevices,
  processSelectedDevices,
  processRemovedDevices,
  updateSelectedDevicesWithParentChannel,
  toggleSelectedSites,
  initializeSelectedDevicesAndRoles,
} = useDeviceRoleHelper(devices);

const additionalGroupTypes = computed(() => [
  {
    type: GROUP_TYPES.NETWORK_SPEAKER,
    label: t('Network Speaker'),
  },
  {
    type: GROUP_TYPES.POE_SWITCH,
    label: t('PoE Switch'),
  },
]);

const currentSelectedSites = computed(() => {
  return sites.value
    .filter((site) => site.devices.some((device) => currentSelectedDevices.value.includes(device.deviceId)))
    .map((item) => item.id);
});

const isSelectAllMap = computed(() => {
  return sites.value.reduce(
    (acc, group) => ({
      ...acc,
      [group.id]: group.devices.every((item) => currentSelectedDevices.value.includes(item.deviceId)),
    }),
    {},
  );
});

const isProcessing = computed(() => {
  return modalState.value === DIALOGUE.STATE.PROCESSING;
});

const isError = computed(() => {
  return modalState.value === DIALOGUE.STATE.ERROR;
});

const isInvalidSelection = computed(() => {
  return currentSelectedDevices.value.length === 0;
});

const isSearching = computed(() => {
  return searchName.value.length > 0;
});

const activeDeviceId = computed(() => {
  return groupState.value.activeDeviceId;
});

const dialogueTitle = computed(() => {
  return props.title || t('Select Devices');
});

const selectedLengthHint = computed(() => {
  const count = currentSelectedDevices.value.length;
  return t('0 device is selected | 1 device is selected | {count} devices are selected', { count });
});

const filteredSites = computed(() => {
  if (isSearching.value) {
    return sites.value;
  }

  return sites.value.filter((item) => focusSiteId.value === item.id);
});

const hasSearchResult = computed(() => {
  return Object.entries(displayDevices.value).length > 0;
});

const displayDevices = computed(() => {
  const displayResult = {};

  sites.value.forEach((group) => {
    let result = group.devices;
    if (isSearching.value) {
      result = result.filter((item) => item.displayName.toLowerCase().includes(searchName.value.toLowerCase()));
    }
    if (result.length > 0) {
      displayResult[group.id] = result;
    }
  });
  return displayResult;
});

const buttonIconStatusMapping = computed(() => {
  return {
    ...DIALOGUE.PRIMARY_ACITON_BUTTON_MAPPING,
    [DIALOGUE.STATE.DEFAULT]: [
      { status: isInvalidSelection.value ? 'disabled' : '', icon: '' },
      { status: '', icon: '' },
    ],
  };
});

const currentFocusSite = computed(() => {
  if (!focusSiteId.value) {
    return null;
  }
  return sites.value.find((site) => site.id === focusSiteId.value) || null;
});

const currentFocusSiteInfo = computed(() => {
  if (!currentFocusSite.value) {
    return null;
  }

  const totalDevices = currentFocusSite.value.devices.length;
  const selectedDevices = currentFocusSite.value.devices.filter((device) =>
    currentSelectedDevices.value.includes(device.deviceId),
  ).length;

  return `${t('Selected Devices in')} ${currentFocusSite.value.name} (${selectedDevices}/${totalDevices})`;
});

const currentFocusSiteSelectedDevices = computed(() => {
  if (isSearching.value) {
    // When searching, return selected devices from all displayed search results
    const allDisplayedDevices = Object.values(displayDevices.value).flat();
    return allDisplayedDevices.filter((device) => currentSelectedDevices.value.includes(device.deviceId));
  }
  if (!currentFocusSite.value) {
    return [];
  }
  return currentFocusSite.value.devices.filter((device) => currentSelectedDevices.value.includes(device.deviceId));
});

const currentBatchAssignRoleId = computed({
  get: () => batchAssignRoleId.value[focusSiteId.value] || '',
  set: (value) => {
    if (focusSiteId.value) {
      batchAssignRoleId.value = {
        ...batchAssignRoleId.value,
        [focusSiteId.value]: value,
      };
    }
  },
});

const isBatchAssignDisabled = computed(() => {
  return currentFocusSiteSelectedDevices.value.length === 0;
});

const changeFocusSite = (siteId) => {
  focusSiteId.value = siteId;
};

const setFirstSiteToDefaultFocusSite = () => {
  if (!sites.value.length) {
    return;
  }
  const defaultFocusSiteId = sites.value[0].id;
  changeFocusSite(defaultFocusSiteId);
};

const clearInput = () => {
  searchName.value = '';
};

const setDefault = () => {
  modalState.value = DIALOGUE.STATE.DEFAULT;
  batchAssignRoleId.value = {};
  store.commit('user/resetSelectUserDeviceRoles');
  clearInput();
  setFirstSiteToDefaultFocusSite();
  initializeSelectedDevicesAndRoles();
};

const openDialogue = () => {
  setDefault();
  modal.value?.show();
};

const selectDevice = (deviceId) => {
  if (props.multiple) {
    return;
  }
  currentSelectedDevices.value = [deviceId];
};

const changeFocusSiteAndClearInput = (siteId) => {
  clearInput();
  changeFocusSite(siteId);
  if (siteList.value) {
    siteList.value.scrollTop = 0;
  }
};

const checkIsSelectIndeterminate = (siteDevices) => {
  if (devices.value.length === 0 || !siteDevices || siteDevices.length === 0) {
    return false;
  }
  const devicesId = siteDevices.map((item) => item.deviceId);
  return (
    devicesId.every((item) => currentSelectedDevices.value.includes(item)) === false &&
    devicesId.some((item) => currentSelectedDevices.value.includes(item))
  );
};

const searchInputChange = (input) => {
  if (!input) {
    setFirstSiteToDefaultFocusSite();
  }
};

const shouldDisplayThumbnail = (siteType) => {
  return siteType !== GROUP_TYPES.NVR && siteType !== GROUP_TYPES.BRIDGE && siteType !== GROUP_TYPES.VSS;
};

const updateDeviceRole = (deviceId, role) => {
  deviceRoles.value[deviceId] = {
    roleId: role?.id || null,
    roleName: role?.name || '',
  };
};

const handleConfirm = async (isConfirm) => {
  if (!isConfirm) {
    return;
  }

  if (!props.closeOnSelect) {
    modalState.value = DIALOGUE.STATE.PROCESSING;
  }

  const grantedDevicesMap = new Map();
  const selectedDeviceIdsSet = new Set(currentSelectedDevices.value);

  processSelectedDevices({ selectedDeviceIdsSet, grantedDevicesMap });
  processRemovedDevices({ selectedDeviceIdsSet, grantedDevicesMap });

  const grantedDevices = Array.from(grantedDevicesMap.values());

  try {
    await store.dispatch('user/updateDeviceRoleOfUser', { userId: props.userId, assignments: grantedDevices });
    modalState.value = DIALOGUE.STATE.SUCCESS;
    emit('success');
  } catch (error) {
    modalState.value = DIALOGUE.STATE.ERROR;
  }
};

const toggleSelectedDevices = ({ selectedDevices }) => {
  currentSelectedDevices.value = updateSelectedDevicesWithParentChannel(selectedDevices, currentSelectedDevices.value);
};

const selectAll = (groupId) => {
  const devicesId = displayDevices.value[groupId].map((device) => device.deviceId);
  const currentSelected = currentSelectedDevices.value;
  const isAllSelected = devicesId.every((deviceId) => currentSelectedDevices.value.includes(deviceId));

  if (isAllSelected) {
    const targetSelectedDevices = currentSelected.filter((deviceId) => !devicesId.includes(deviceId));
    currentSelectedDevices.value = updateSelectedDevicesWithParentChannel(targetSelectedDevices, currentSelected);
  } else {
    const targetSelectedDevices = [...new Set([...currentSelected, ...devicesId])];
    currentSelectedDevices.value = updateSelectedDevicesWithParentChannel(targetSelectedDevices, currentSelected);
  }
};

const batchAssignRole = (role) => {
  if (isBatchAssignDisabled.value) {
    return;
  }
  currentBatchAssignRoleId.value = role?.id || '';
  currentFocusSiteSelectedDevices.value.forEach((device) => {
    deviceRoles.value[device.deviceId] = {
      roleId: role?.id || null,
      roleName: role?.name || '',
    };
  });
};

defineExpose({
  openDialogue,
});

onMounted(async () => {
  setFirstSiteToDefaultFocusSite();
  await store.dispatch('user/fetchDefaultDeviceRoleList');
});
</script>

<style lang="less" scoped>
.device-access-dialogue {
  cursor: default;

  .main-wrapper {
    > div:not(.header) {
      padding-left: 0px;
      padding-right: 0px;
    }

    .content-wrapper {
      display: flex;
      flex-direction: column;
      min-height: 0;
      flex: 1;
      > div {
        padding-left: 40px;
        padding-right: 40px;
      }
    }
  }

  .site-wrapper {
    display: flex;
    flex-direction: column;
  }
  .search-container {
    display: flex;
    flex-direction: row;
  }
  .search-input {
    position: relative;
    width: 300px;
    height: 32px;
  }
  .hint {
    padding-bottom: 20px;
    border-bottom: 1px solid @color-surface05;
    h3 {
      color: @color-primary;
      line-height: 37px;
    }
    h6 {
      color: @color-text03;
      line-height: 20px;
      margin-top: 10px;
      &.error {
        color: @color-alert;
      }
    }
  }
  .site-header-container {
    padding: 18px 18px 18px 0;
  }
  .site-hint,
  .site-batch-selector-hint {
    font-weight: 700;
    font-size: 14px;
    color: @color-text01;
  }
  .site-batch-assign-container {
    display: flex;
    align-items: center;
    column-gap: 20px;
    padding: 18px 0;
  }
  .site-batch-assign-selector {
    width: 30%;
  }
  .dialogue-content {
    flex: 1;
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    position: relative;
    min-height: 0;
    padding-top: 10px;

    .left-menu {
      background-color: @color-surface03;
      border-right: 1px solid #000;
      height: 100%;
    }
    .center-view {
      flex: 1;
      display: flex;
      flex-direction: column;
      margin-left: 20px;
      overflow-x: hidden;
      height: 100%;
    }
  }
  .site-list {
    overflow-y: auto;
    height: 440px;
    margin-bottom: 20px;
    .site-device-list {
      :deep(.device) {
        h6 {
          max-width: 500px;
        }
        .svg-icon {
          &[data-state='active'] {
            background-color: transparent;
          }
        }
      }
    }
  }
  .site-title {
    font-weight: bold;
    padding: 18px;
    font-size: 16px;
    align-items: center;
    line-height: 24px;
    .text-ellipsis;
  }
  .site-device-container {
    display: flex;
    flex-direction: row;
    align-items: center;
    padding: 12px 12px 12px 18px;
    background-color: @color-surface07;

    :deep(.check-box .svg-icon) {
      margin-right: 10px;
    }
  }
  .site-device-subtitle-container {
    width: 100%;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 14px;
    color: @color-text01;
  }
  .device-role-dropdown-subtitle {
    width: 100%;
    max-width: 150px;
  }
  .no-result-container {
    height: 440px;
    text-align: center;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }
  :deep(.single-device) {
    width: 100%;
  }
}

:deep(.device-wrapper) {
  display: flex;
  align-items: center;
  justify-content: space-between;

  & .device {
    width: 100%;
  }

  & .device-role-dropdown {
    width: 150px;
  }
}
</style>
