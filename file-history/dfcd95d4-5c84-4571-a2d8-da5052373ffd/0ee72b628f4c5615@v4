import { ref, computed, watch } from 'vue';
import { useI18n } from 'vue-i18n';
import { useStore } from 'vuex';

/**
 * Device Access related logic
 * @param {import('vue').Ref} currentUser - The user being viewed
 */
export default function useDeviceAccessHelper(currentUser) {
  const store = useStore();
  const { t } = useI18n();

  const selectedSites = ref([]);

  const deviceOverview = computed(() => store.getters['user/detailDeviceOverview']);
  const isLoading = computed(() => store.getters['user/detailIsLoading']);
  const myDevices = computed(() => store.getters['device/availableDevices'] || []);
  const mySites = computed(() => store.getters['group/groupsList'] || []);

  const findMyDeviceInfo = (thingName, derivant) => {
    return myDevices.value.find(
      (device) => device.thingName === thingName && (device.options?.derivant === derivant || derivant === 'none'),
    );
  };

  const findSiteName = (siteId) => {
    const group = mySites.value.find((g) => g.id === siteId);
    return group?.name || '-';
  };

  /**
   * Transform API raw data (grantedDevices) into sites structure
   */
  const sites = computed(() => {
    const grantedDevices = deviceOverview.value || [];
    if (grantedDevices.length === 0) {
      return [];
    }

    const siteMap = new Map();

    grantedDevices.forEach((grantedDevice) => {
      const { thingName, derivant, siteId, roleId, roleName } = grantedDevice;

      if (!siteMap.has(siteId)) {
        siteMap.set(siteId, {
          id: siteId,
          name: findSiteName(siteId),
          devices: [],
        });
      }

      const myDeviceInfo = findMyDeviceInfo(thingName, derivant);

      siteMap.get(siteId).devices.push({
        id: `${thingName}-${derivant}`,
        thingName,
        derivant,
        name: myDeviceInfo?.displayName || thingName,
        type: myDeviceInfo?.type || 'camera',
        role: roleName,
        roleId,
      });
    });

    return Array.from(siteMap.values());
  });

  watch(
    [selectedSites, sites],
    ([newSelectedSites, newSites]) => {
      if (newSelectedSites.length === 0 && newSites.length > 0) {
        selectedSites.value = newSites.map((site) => site.id);
      }
    },
    { immediate: true },
  );

  const totalAccess = computed(() => {
    return sites.value.reduce((total, site) => total + site.devices.length, 0);
  });

  const isOverviewEmpty = computed(() => totalAccess.value === 0);

  const tableSearchStatus = computed(() => {
    if (isLoading.value) {
      return 'loading';
    }
    if (isOverviewEmpty.value) {
      return 'no-device-group';
    }
    return '';
  });

  const siteOptions = computed(() => {
    return sites.value.map((site) => ({
      value: site.id,
      text: site.name,
    }));
  });

  const filteredSites = computed(() => {
    if (selectedSites.value.length === 0) {
      return sites.value;
    }
    return sites.value.filter((site) => selectedSites.value.includes(site.id));
  });

  const filterTitle = computed(() => {
    if (selectedSites.value.length === 0 || selectedSites.value.length === sites.value.length) {
      return t('All');
    }
    return selectedSites.value
      .map((id) => sites.value.find((site) => site.id === id)?.name)
      .filter(Boolean)
      .join(', ');
  });

  const fetchDeviceAccess = async () => {
    if (!currentUser.value?.userSub) {
      return;
    }
    await store.dispatch('user/fetchUserGrantedDevices', { userSub: currentUser.value.userSub });

    // TODO: Remove mock data
    store.commit('user/setDetailDeviceOverview', [
      // ...(deviceOverview.value || []),
      // Camera in site A
      {
        thingName: '0002D1A9600D-1708586038820',
        derivant: 'none',
        siteId: '9f8076ac-bc4a-4c2d-a75f-e83cb1795eb1',
        roleId: 'mock-role-id',
        roleName: 'Mock Role',
      },
      // NVR channel in same site
      {
        thingName: '0002D1BBBBBB-1234567890',
        derivant: 'ch0',
        siteId: '9f8076ac-bc4a-4c2d-a75f-e83cb1795eb1',
        roleId: 'mock-role-id',
        roleName: 'Mock Role',
      },
      // NVR 本體 - 放在「額外群組」(如 "Parent Devices" 或 "Ungrouped")
      {
        thingName: '0002D1BBBBBB-1234567890',
        derivant: 'none',
        siteId: 'parent-devices-group',
        roleId: 'mock-role-id',
        roleName: 'Mock Role',
      },
    ]);
  };

  return {
    selectedSites,
    sites,
    totalAccess,
    isLoading,
    isOverviewEmpty,
    tableSearchStatus,
    siteOptions,
    filteredSites,
    filterTitle,
    fetchDeviceAccess,
  };
}
