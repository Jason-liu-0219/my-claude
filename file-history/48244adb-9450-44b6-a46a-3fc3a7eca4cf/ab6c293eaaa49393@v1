<template>
  <AppDialogue
    ref="modal"
    class="device-access-dialogue"
    data-testid="device-access-dialogue"
    name="DeviceAccessDialogue"
    :closeWhenClickButton="closeOnSelect"
    :title="dialogueTitle"
    :subTitle="subTitle"
    :primaryText="isProcessing ? $t('Selecting') : $t('Select')"
    :buttonIconStatusMapping="buttonIconStatusMapping"
    :state="modalState"
    height="720px"
    width="1116px"
    @confirm="handleConfirm"
  >
    <template #content>
      <div class="content-wrapper">
        <!-- Header Hint -->
        <div class="hint">
          <h3 class="bold">
            {{ selectedLengthHint }}
          </h3>
        </div>

        <div class="dialogue-content">
          <!-- Left: Site Group List -->
          <div class="left-menu">
            <DeviceGroupList
              :multiple="multiple"
              :groupList="sites"
              :currentSelectedGroups="currentSelectedSites"
              :currentSelectedDevices="currentSelectedDevices"
              :focusGroupId="focusSiteId"
              :isSearching="isSearching"
              @toggleSelectedGroups="toggleSelectedSites"
              @changeFocusGroup="handleChangeFocusSite"
            />
          </div>

          <!-- Center: Device List -->
          <div class="center-view">
            <!-- Search Input -->
            <div class="search-container">
              <AppInputFields
                id="search-device-fields"
                v-model.lazy="searchName"
                class="search-input"
                type="search"
                :disabled="devices.length === 0"
                @input="handleSearchInput"
              />
            </div>

            <!-- Site Info Header -->
            <div
              v-if="hasSearchResult && currentFocusSiteInfo"
              class="site-header-container"
            >
              <h6 class="site-hint">
                {{ currentFocusSiteInfo }}
              </h6>
            </div>

            <!-- Batch Assign Role -->
            <div
              v-if="hasSearchResult"
              class="site-batch-assign-container"
            >
              <h6 class="site-batch-selector-hint">
                {{ t('Update Selected Devices Access') }}
              </h6>
              <div class="site-batch-assign-selector">
                <DeviceRoleDropdown
                  class="device-role-dropdown"
                  :modelValue="currentBatchAssignRoleId"
                  :placeholder="t('Select Role to assign')"
                  :disabled="isBatchAssignDisabled"
                  @selected="handleBatchAssignRole"
                />
              </div>
            </div>

            <!-- Device List by Site -->
            <div
              v-if="hasSearchResult"
              ref="siteList"
              class="site-list"
            >
              <div
                v-for="site in filteredSites"
                :key="site.id"
                class="site-wrapper"
              >
                <template v-if="displayDevices[site.id]">
                  <h6
                    class="site-title"
                    :title="site.name"
                  >
                    {{ site.name }}
                  </h6>

                  <div class="site-device-container">
                    <AppCheckBox
                      v-if="multiple"
                      v-model.lazy="isSelectAllMap[site.id]"
                      :indeterminate="isIndeterminate(site.devices)"
                      :disabled="site.devices.length === 0"
                      @click.prevent="handleSelectAll(site.id)"
                    />
                    <span>{{ DEVICE_TYPE_LABELS[site.type] }}</span>
                  </div>

                  <AppDeviceList
                    class="site-device-list"
                    :multiple="multiple"
                    :selectMode="!multiple"
                    :devicesData="displayDevices[site.id]"
                    :activeDeviceId="activeDeviceId"
                    :defaultSelectedDevices="currentSelectedDevices"
                    :enableListItemActive="false"
                    :shouldDisplayThumbnail="shouldDisplayThumbnail(site.type)"
                    @toggleSelectedDevices="handleToggleSelectedDevices"
                    @selectDevice="handleSelectDevice"
                  >
                    <template #rear="{ device }">
                      <DeviceIndicator
                        v-if="device.nvrName"
                        :device="device"
                      />
                      <DeviceIndicator
                        v-if="device.vssName"
                        :device="device"
                      />
                    </template>
                    <template #dropdown="{ device }">
                      <DeviceRoleDropdown
                        class="device-role-dropdown"
                        :modelValue="deviceRoles[device.deviceId]?.roleId || ''"
                        :placeholder="$t('Select Role')"
                        :initialDisplayText="deviceRoles[device.deviceId]?.roleName || ''"
                        @selected="(role) => updateDeviceRole(device.deviceId, role)"
                      />
                    </template>
                  </AppDeviceList>
                </template>
              </div>
            </div>

            <!-- No Result -->
            <div
              v-else
              class="no-result-container"
            >
              <SvgIcon
                class="no-result-icon"
                iconClass="search_failed"
                size="100px"
              />
              <h6 class="text">
                {{ $t('No search results') }}
              </h6>
            </div>
          </div>
        </div>
      </div>
    </template>

    <template
      v-if="isError"
      #errorMessage
    >
      <AppFormErrorMessage :message="errorMessage" />
    </template>
  </AppDialogue>
</template>

<script setup>
import { ref, computed, watch, useTemplateRef, onMounted } from 'vue';
import { useI18n } from 'vue-i18n';
import { useStore } from 'vuex';

import { DeviceIndicator, DeviceGroupList, AppDeviceList } from '@vivotek/advanced-vue-components';
import { DIALOGUE, GROUP_TYPES } from '@vivotek/const-vsaas';

import DeviceRoleDropdown from '@/components/Dropdowns/DeviceRoleDropdown.vue';
import { PERMISSION_DEVICE_SCOPE } from '@/constants/Permission';
import { composeDeviceId, useDeviceRoleHelper } from '@/pages/user/detail/composables/useDeviceRoleHelper';

// ============================================================
// Props & Emits
// ============================================================
const props = defineProps({
  multiple: {
    type: Boolean,
    default: true,
  },
  availableDevices: {
    type: Array,
    default: () => null,
  },
  closeOnSelect: {
    type: Boolean,
    default: false,
  },
  title: {
    type: String,
    default: null,
  },
  subTitle: {
    type: String,
    default: null,
  },
  userId: {
    type: String,
    default: '',
  },
});

const emit = defineEmits(['success']);

// ============================================================
// Composables & Refs
// ============================================================
const store = useStore();
const { t } = useI18n();

const modal = useTemplateRef('modal');
const siteList = useTemplateRef('siteList');

// ============================================================
// State
// ============================================================
const modalState = ref(DIALOGUE.STATE.DEFAULT);
const searchName = ref('');
const isSearching = ref(false);
const focusSiteId = ref('');

// Selection State
const currentSelectedDevices = ref([]);
const currentSelectedSites = ref([]);
const deviceRoles = ref({});
const originalGrantedDevices = ref(new Map());
const batchAssignRoleId = ref({});

// ============================================================
// Constants
// ============================================================
const DEVICE_TYPE_LABELS = computed(() => ({
  [GROUP_TYPES.VSS]: t('VSS'),
  [GROUP_TYPES.NVR]: t('NVR'),
  [GROUP_TYPES.BRIDGE]: t('Bridge'),
  [GROUP_TYPES.SITE]: t('Cameras'),
}));

// ============================================================
// Store Getters
// ============================================================
const sortedGroups = computed(() => store.getters['group/sortedGroups']);
const userDetailGrantedDevices = computed(() => store.getters['user/detailDeviceOverview']);
const activeDeviceId = computed(() => store.state.group.activeDeviceId);

const availableDevicesWithPermission = computed(() =>
  store.getters['device/getAvailableDevicesWithPermission'](PERMISSION_DEVICE_SCOPE.DEVICE_ALL_USERS),
);

// ============================================================
// Computed: Devices & Sites
// ============================================================
const devices = computed(() => props.availableDevices ?? availableDevicesWithPermission.value ?? []);

const availableDeviceIds = computed(() => devices.value.map((device) => device.deviceId));

const sites = computed(() =>
  sortedGroups
    .value()
    .map((group) => ({
      ...group,
      devices: devices.value.filter((device) => device.options?.deviceGroupID === group.id),
    }))
    .filter((group) => group.devices.length > 0),
);

const filteredSites = computed(() =>
  isSearching.value ? sites.value : sites.value.filter((site) => site.id === focusSiteId.value),
);

const displayDevices = computed(() => {
  const result = {};
  const searchLower = searchName.value.toLowerCase();

  sites.value.forEach((group) => {
    const filtered = isSearching.value
      ? group.devices.filter((item) => item.displayName.toLowerCase().includes(searchLower))
      : group.devices;

    if (filtered.length > 0) {
      result[group.id] = filtered;
    }
  });

  return result;
});

const hasSearchResult = computed(() => Object.keys(displayDevices.value).length > 0);

// ============================================================
// Computed: Current Focus Site
// ============================================================
const currentFocusSite = computed(() =>
  focusSiteId.value ? sites.value.find((site) => site.id === focusSiteId.value) : null,
);

const currentFocusSiteInfo = computed(() => {
  if (!currentFocusSite.value) return null;

  const { devices: siteDevices, name } = currentFocusSite.value;
  const total = siteDevices.length;
  const selected = siteDevices.filter((d) => currentSelectedDevices.value.includes(d.deviceId)).length;

  return `${t('Selected Devices in')} ${name} (${selected}/${total})`;
});

const currentFocusSiteSelectedDevices = computed(() => {
  if (!currentFocusSite.value || isSearching.value) return [];
  return currentFocusSite.value.devices.filter((d) => currentSelectedDevices.value.includes(d.deviceId));
});

// ============================================================
// Computed: Batch Assign
// ============================================================
const currentBatchAssignRoleId = computed({
  get: () => batchAssignRoleId.value[focusSiteId.value] || '',
  set: (value) => {
    if (focusSiteId.value) {
      batchAssignRoleId.value = { ...batchAssignRoleId.value, [focusSiteId.value]: value };
    }
  },
});

const isBatchAssignDisabled = computed(() => currentFocusSiteSelectedDevices.value.length === 0);

// ============================================================
// Computed: Selection State
// ============================================================
const isSelectAllMap = computed(() =>
  sites.value.reduce(
    (acc, group) => ({
      ...acc,
      [group.id]: group.devices.every((item) => currentSelectedDevices.value.includes(item.deviceId)),
    }),
    {},
  ),
);

const isInvalidSelection = computed(() => currentSelectedDevices.value.length === 0);

// ============================================================
// Computed: Dialogue State
// ============================================================
const isProcessing = computed(() => modalState.value === DIALOGUE.STATE.PROCESSING);
const isError = computed(() => modalState.value === DIALOGUE.STATE.ERROR);

const dialogueTitle = computed(() => props.title || t('Select Devices'));

const selectedLengthHint = computed(() => {
  const count = currentSelectedDevices.value.length;
  return t('0 device is selected | 1 device is selected | {count} devices are selected', { count });
});

const errorMessage = computed(() => (isError.value ? t('Failed to assign device roles') : ''));

const buttonIconStatusMapping = computed(() => ({
  ...DIALOGUE.PRIMARY_ACITON_BUTTON_MAPPING,
  [DIALOGUE.STATE.DEFAULT]: [
    { status: isInvalidSelection.value ? 'disabled' : '', icon: '' },
    { status: '', icon: '' },
  ],
}));

// ============================================================
// Helpers
// ============================================================
const { processSelectedDevices, processRemovedDevices, updateSelectedDevicesWithParentChannel } =
  useDeviceRoleHelper(devices);

const shouldDisplayThumbnail = (siteType) =>
  ![GROUP_TYPES.NVR, GROUP_TYPES.BRIDGE, GROUP_TYPES.VSS].includes(siteType);

const isIndeterminate = (siteDevices) => {
  if (!siteDevices?.length) return false;
  const deviceIds = siteDevices.map((d) => d.deviceId);
  const someSelected = deviceIds.some((id) => currentSelectedDevices.value.includes(id));
  const allSelected = deviceIds.every((id) => currentSelectedDevices.value.includes(id));
  return someSelected && !allSelected;
};

const getSiteDeviceIds = (siteIds) =>
  sites.value
    .filter((site) => siteIds.includes(site.id))
    .flatMap((site) => site.devices)
    .map((d) => d.deviceId)
    .filter((id) => availableDeviceIds.value.includes(id));

// ============================================================
// State Management
// ============================================================
const setFocusSite = (siteId) => {
  focusSiteId.value = siteId;
};

const setFirstSiteAsDefault = () => {
  if (sites.value.length) {
    setFocusSite(sites.value[0].id);
  }
};

const clearSearch = () => {
  searchName.value = '';
  isSearching.value = false;
};

const initializeSelectedDevicesAndRoles = () => {
  if (!userDetailGrantedDevices.value?.length) return;

  const selectedIds = [];
  const roleMapping = {};
  const availableSet = new Set(availableDeviceIds.value);

  originalGrantedDevices.value.clear();

  userDetailGrantedDevices.value.forEach((grantedDevice) => {
    const deviceId = composeDeviceId(grantedDevice.thingName, grantedDevice.derivant);
    originalGrantedDevices.value.set(deviceId, { ...grantedDevice });

    if (availableSet.has(deviceId)) {
      selectedIds.push(deviceId);
      roleMapping[deviceId] = {
        roleId: grantedDevice.roleId || '',
        roleName: grantedDevice.roleName || '',
      };
    }
  });

  currentSelectedDevices.value = selectedIds;
  deviceRoles.value = roleMapping;
};

const resetDialogueState = () => {
  modalState.value = DIALOGUE.STATE.DEFAULT;
  batchAssignRoleId.value = {};
  clearSearch();
  setFirstSiteAsDefault();
  initializeSelectedDevicesAndRoles();
};

// ============================================================
// Event Handlers
// ============================================================
const handleChangeFocusSite = (siteId) => {
  clearSearch();
  setFocusSite(siteId);
  if (siteList.value) {
    siteList.value.scrollTop = 0;
  }
};

const handleSearchInput = (input) => {
  isSearching.value = !!input;
  if (!input) {
    setFirstSiteAsDefault();
  }
};

const handleSelectDevice = (deviceId) => {
  if (!props.multiple) {
    currentSelectedDevices.value = [deviceId];
  }
};

const handleToggleSelectedDevices = ({ selectedDevices }) => {
  currentSelectedDevices.value = updateSelectedDevicesWithParentChannel(selectedDevices, currentSelectedDevices.value);
};

const handleSelectAll = (groupId) => {
  const deviceIds = displayDevices.value[groupId].map((d) => d.deviceId);
  const currentSelected = currentSelectedDevices.value;
  const isAllSelected = deviceIds.every((id) => currentSelected.includes(id));

  const targetDevices = isAllSelected
    ? currentSelected.filter((id) => !deviceIds.includes(id))
    : [...new Set([...currentSelected, ...deviceIds])];

  currentSelectedDevices.value = updateSelectedDevicesWithParentChannel(targetDevices, currentSelected);
};

const toggleSelectedSites = (selectedSites, indeterminateSites = []) => {
  const indeterminateDeviceIds = getSiteDeviceIds(indeterminateSites).filter((id) =>
    currentSelectedDevices.value.includes(id),
  );
  const fullySelectedSites = selectedSites.filter((site) => !indeterminateSites.includes(site));
  const fullySelectedDeviceIds = getSiteDeviceIds(fullySelectedSites);

  currentSelectedSites.value = selectedSites;
  currentSelectedDevices.value = [...fullySelectedDeviceIds, ...indeterminateDeviceIds];
};

const updateDeviceRole = (deviceId, role) => {
  deviceRoles.value[deviceId] = {
    roleId: role?.id || '',
    roleName: role?.name || '',
  };
};

const handleBatchAssignRole = (role) => {
  if (!role || isBatchAssignDisabled.value) return;

  currentBatchAssignRoleId.value = role.id;

  currentFocusSiteSelectedDevices.value.forEach((device) => {
    deviceRoles.value[device.deviceId] = {
      roleId: role.id,
      roleName: role.name,
    };
  });
};

const handleConfirm = async (isConfirm) => {
  if (!isConfirm) return;

  if (!props.closeOnSelect) {
    modalState.value = DIALOGUE.STATE.PROCESSING;
  }

  const grantedDevicesMap = new Map();
  const selectedDeviceIdsSet = new Set(currentSelectedDevices.value);

  processSelectedDevices(currentSelectedDevices.value, deviceRoles.value, selectedDeviceIdsSet, grantedDevicesMap);
  processRemovedDevices(originalGrantedDevices.value, selectedDeviceIdsSet, grantedDevicesMap);

  try {
    await store.dispatch('user/assignDeviceRole', {
      userId: props.userId,
      assignments: Array.from(grantedDevicesMap.values()),
    });
    modalState.value = DIALOGUE.STATE.SUCCESS;
    emit('success');
  } catch {
    modalState.value = DIALOGUE.STATE.ERROR;
  }
};

// ============================================================
// Public Methods
// ============================================================
const openDialogue = () => {
  resetDialogueState();
  modal.value?.show();
};

defineExpose({ openDialogue });

// ============================================================
// Watchers
// ============================================================
watch(
  currentSelectedDevices,
  (newValue) => {
    currentSelectedSites.value = sites.value
      .filter((site) => site.devices.some((d) => newValue.includes(d.deviceId)))
      .map((site) => site.id);
  },
  { immediate: true },
);

// ============================================================
// Lifecycle
// ============================================================
onMounted(async () => {
  setFirstSiteAsDefault();
  await store.dispatch('user/fetchDefaultDeviceRoleList');
});
</script>

<style lang="less" scoped>
.device-access-dialogue {
  cursor: default;

  .main-wrapper {
    > div:not(.header) {
      padding-left: 0px;
      padding-right: 0px;
    }

    .content-wrapper {
      display: flex;
      flex-direction: column;
      min-height: 0;
      flex: 1;

      > div {
        padding-left: 40px;
        padding-right: 40px;
      }
    }
  }

  .hint {
    padding-bottom: 20px;
    border-bottom: 1px solid @color-surface05;

    h3 {
      color: @color-primary;
      line-height: 37px;
    }

    h6 {
      color: @color-text03;
      line-height: 20px;
      margin-top: 10px;

      &.error {
        color: @color-alert;
      }
    }
  }

  .dialogue-content {
    flex: 1;
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    position: relative;
    min-height: 0;
    padding-top: 10px;

    .left-menu {
      background-color: @color-surface03;
      border-right: 1px solid #000;
      height: 100%;
    }

    .center-view {
      flex: 1;
      display: flex;
      flex-direction: column;
      margin-left: 20px;
      overflow-x: hidden;
      height: 100%;
    }
  }

  .search-container {
    display: flex;
    flex-direction: row;
  }

  .search-input {
    position: relative;
    width: 300px;
    height: 32px;
  }

  .site-header-container {
    padding: 18px 18px 18px 0;
  }

  .site-hint,
  .site-batch-selector-hint {
    font-weight: 700;
    font-size: 14px;
    color: @color-text01;
  }

  .site-batch-assign-container {
    display: flex;
    align-items: center;
    column-gap: 20px;
    padding: 18px 0;
  }

  .site-batch-assign-selector {
    width: 30%;
  }

  .site-wrapper {
    display: flex;
    flex-direction: column;
  }

  .site-title {
    font-weight: bold;
    padding: 18px;
    font-size: 16px;
    align-items: center;
    line-height: 24px;
    .text-ellipsis;
  }

  .site-device-container {
    display: flex;
    flex-direction: row;
    align-items: center;
    padding: 12px;
    background-color: @color-surface07;

    :deep(.check-box .svg-icon) {
      margin-right: 10px;
    }
  }

  .site-list {
    overflow-y: auto;
    height: 440px;
    margin-bottom: 20px;

    .site-device-list {
      :deep(.device) {
        h6 {
          max-width: 500px;
        }

        .svg-icon {
          &[data-state='active'] {
            background-color: transparent;
          }
        }
      }
    }
  }

  .no-result-container {
    height: 440px;
    text-align: center;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  :deep(.single-device) {
    width: 100%;
  }
}

:deep(.device-wrapper) {
  display: flex;
  align-items: center;
  justify-content: space-between;

  & .device {
    width: 100%;
  }

  & .device-role-dropdown {
    width: 30%;
  }
}
</style>
