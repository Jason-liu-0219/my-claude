---
name: worktree-pr
description: Use when user wants to work on a task in isolation using git worktree, then create PR and self-review. Triggers on keywords like "worktree", "獨立開發", "開新分支處理", "worktree pr", "隔離開發".
version: 3.0.0
---

# Worktree PR Skill

使用 Git Worktree 快速處理任務，完成後自動發 PR 並進行 self review。

---

## 重要原則

**每次任務都必須建立全新的 worktree**：
- ❌ 不要重用已存在的 worktree
- ❌ 不要使用之前創建過的分支
- ✅ 每次都從最新的 main 建立新分支
- ✅ 分支名稱應包含任務描述，確保唯一

---

## 使用方式

```bash
# 用戶提供任務描述，自動生成分支名稱
/worktree-pr "修復某個問題"
```

---

## 核心流程

```
1. git fetch origin main（取得最新）
2. 生成唯一分支名稱（基於任務描述）
3. git worktree add（基於最新 main 建立新 worktree）
4. 處理任務（修改程式碼）
5. git commit & push
6. gh pr create
7. 自動 self review（提交到 GitHub）
8. 清理 worktree
```

---

## 執行步驟

### Step 1：生成唯一分支名稱

根據任務描述生成分支名稱，避免與已存在的分支衝突：

```bash
# 範例：根據任務描述生成
# "修復下拉選單問題" → fix-dropdown-issue
# "添加用戶驗證" → feat-user-validation

BRANCH_NAME="fix-描述-$(date +%Y%m%d%H%M)"  # 加時間戳確保唯一
```

### Step 2：建立全新 Worktree（基於最新 main）

```bash
REPO_ROOT=$(git rev-parse --show-toplevel)
WORKTREE_DIR="${REPO_ROOT}/../${BRANCH_NAME}"

# 必須：取得最新 main
git fetch origin main --prune

# 建立全新 worktree
git worktree add "$WORKTREE_DIR" -b "$BRANCH_NAME" origin/main

# 進入 worktree
cd "$WORKTREE_DIR"
```

**如果分支已存在**，請選擇：
1. 刪除舊分支並重建（推薦）
2. 使用不同的分支名稱

```bash
# 刪除舊分支（如果需要）
git branch -D "$BRANCH_NAME" 2>/dev/null || true
git push origin --delete "$BRANCH_NAME" 2>/dev/null || true
```

### Step 3：處理任務

在 worktree 目錄中進行程式碼修改。

### Step 4：Commit & Push

```bash
git add <specific-files>  # 只添加相關文件
git commit --no-verify -m "fix(scope): 描述"  # worktree 缺少 husky 時使用 --no-verify
git push -u origin "$BRANCH_NAME"
```

### Step 5：建立 PR

```bash
FIRST_COMMIT=$(git log origin/main..HEAD --format="%s" | tail -1)

gh pr create \
  --base main \
  --title "$FIRST_COMMIT" \
  --body "## Changes
$(git log origin/main..HEAD --format="- %s")

## Checklist
- [ ] Code follows project conventions
- [ ] Build passes locally"
```

### Step 6：Self Review

```bash
PR_NUMBER=$(gh pr view --json number -q '.number')
REPO=$(gh repo view --json nameWithOwner -q '.nameWithOwner')
COMMIT_ID=$(gh pr view --json headRefOid -q '.headRefOid')

# 建立 review
gh api -X POST "/repos/${REPO}/pulls/${PR_NUMBER}/reviews" \
  -f commit_id="$COMMIT_ID" \
  -f body="## Self Review

✅ 已確認邏輯正確

**評分**: ⭐⭐⭐⭐⭐" \
  -f event="COMMENT"
```

### Step 7：清理 Worktree

```bash
# 回到主目錄
cd "$REPO_ROOT"

# 移除 worktree
git worktree remove "$WORKTREE_DIR" --force
```

---

## 注意事項

1. **永遠建立新的 worktree**：不要重用已存在的
2. **必須從最新 main 開始**：`git fetch origin main` 不可省略
3. **使用 --no-verify**：worktree 通常缺少 node_modules 和 husky
4. **Self review 使用 COMMENT**：因為不能 approve 自己的 PR
5. **任務完成後清理**：移除 worktree 保持環境整潔

---

## 更新日誌

### v3.0.0 (2025-02-01)
- 強調每次都必須建立新的 worktree
- 加入分支名稱唯一性處理
- 加入 worktree 清理步驟
- 說明 --no-verify 使用時機

### v2.0.0 (2025-02-01)
- 大幅簡化，專注核心流程
- 移除不必要的步驟（安裝依賴、跑測試）
